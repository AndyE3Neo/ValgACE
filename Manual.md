Описание
ValgAce - это модуль для Klipper, обеспечивающий управление устройством ACE (автоматической системой смены филамента). Модуль предоставляет полный набор функций для работы с устройством через последовательный интерфейс.

Основные функции
Управление филаментом
Загрузка/выгрузка филамента (ACE_FEED, ACE_RETRACT)

Автоматическая парковка в инструмент (ACE_PARK_TO_TOOLHEAD)

Смена инструмента (ACE_CHANGE_TOOL)

Ассистент подачи (ACE_ENABLE_FEED_ASSIST, ACE_DISABLE_FEED_ASSIST)

Управление сушкой
Запуск сушки (ACE_START_DRYING)

Остановка сушки (ACE_STOP_DRYING)

Информационные функции
Получение статуса (ACE_STATUS)

Информация о филаменте (ACE_FILAMENT_INFO)

Отладка соединения (ACE_DEBUG)

Установка и настройка
Скопируйте файл ace.py в директорию ~/klipper/klippy/extras/

Добавьте в printer.cfg секцию конфигурации:

[ace]
serial: /dev/ttyACM0         # Порт устройства
baud: 115200                 # Скорость обмена
log_dir: /var/log/ace        # Директория для логов
log_level: INFO              # Уровень логирования (DEBUG, INFO, WARNING, ERROR)
max_log_size: 10             # Макс. размер лог-файла (МБ)
log_backup_count: 3          # Количество ротируемых логов

# Параметры работы
feed_speed: 50               # Скорость подачи (мм/с)
retract_speed: 50            # Скорость отката (мм/с)
toolchange_retract_length: 100 # Длина отката при смене инструмента
park_hit_count: 5            # Количество попыток парковки
max_dryer_temperature: 55    # Макс. температура сушки
disable_assist_after_toolchange: True # Отключить ассистент после смены инструмента

Использование команд
Основные команды
Смена инструмента

ACE_CHANGE_TOOL TOOL=0       # Загрузить инструмент 0
ACE_CHANGE_TOOL TOOL=-1      # Выгрузить текущий инструмент

Управление филаментом

ACE_FEED INDEX=0 LENGTH=50 SPEED=30  # Подать 50мм филамента из слота 0
ACE_RETRACT INDEX=0 LENGTH=50        # Откатить 50мм филамента в слот 0

Управление сушкой

ACE_START_DRYING TEMP=50 DURATION=240  # Сушка при 50°C в течение 4 часов
ACE_STOP_DRYING                        # Остановить сушку

Информационные команды

ACE_STATUS                  # Получить полный статус устройства
ACE_FILAMENT_INFO INDEX=0   # Информация о филаменте в слоте 0
ACE_DEBUG METHOD=get_info   # Отладочная информация

Логирование
Модуль ведет подробное логирование в указанную директорию. Уровень детализации настраивается параметром log_level:

DEBUG - максимальная детализация, включая обмен данными

INFO - основные события и команды

WARNING - только предупреждения и ошибки

ERROR - только критические ошибки

Решение проблем
Устройство не отвечает
Проверьте физическое подключение

Убедитесь в правильности указания порта

Проверьте логи (/var/log/ace/ace.log)

Медленная работа
Уменьшите response_timeout (но не менее 1.0)

Проверьте очередь команд (ACE_DEBUG METHOD=get_queue_info)

Ошибки CRC
Проверьте целостность кабеля

Убедитесь в отсутствии наводок

Попробуйте уменьшить скорость обмена (baud)

Примеры использования
Полная смена инструмента

_ACE_PRE_TOOLCHANGE FROM=1 TO=2
ACE_CHANGE_TOOL TOOL=2
_ACE_POST_TOOLCHANGE FROM=1 TO=2

Сушка филамента с последующей загрузкой

ACE_START_DRYING TEMP=45 DURATION=120
M118 Сушка запущена на 2 часа
ACE_FEED INDEX=2 LENGTH=50 SPEED=20

